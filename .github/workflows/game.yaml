name: Aether Strike - Game Build & Release

on:
  push:
    branches:
      - dev
    paths:
      - 'games/aether_strike/**'
  pull_request:
    paths:
      - 'games/aether_strike/**'
  workflow_dispatch:  # Permet de lancer manuellement

env:
  GAME_NAME: aether_strike
  GAME_PATH: games/aether_strike
  CARGO_TERM_COLOR: always

jobs:
  build-game:
    name: Build Aether Strike (Release)
    runs-on: windows-latest
    
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4

      - name: ü¶Ä Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          targets: x86_64-pc-windows-msvc

      - name: üì¶ Cache Cargo dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: games/aether_strike
          
      - name: üî® Build Aether Strike (Release)
        working-directory: ${{ env.GAME_PATH }}
        run: |
          cargo build --release --verbose
          echo "Build completed successfully!"

      - name: üì¶ Prepare Release & Metadata
        id: prepare_release
        working-directory: ${{ env.GAME_PATH }}
        shell: powershell
        run: |
          $exe_path = "target/release/${{ env.GAME_NAME }}.exe"
          $file_size = (Get-Item $exe_path).Length / 1MB
          $size_mb = [math]::Round($file_size, 2)
          $build_date = Get-Date -Format 'yyyy-MM-dd HH:mm:ss'
          
          # Set outputs
          echo "exe_size=$size_mb MB" >> $env:GITHUB_OUTPUT
          echo "build_date=$build_date" >> $env:GITHUB_OUTPUT
          
          # Dist folder
          New-Item -ItemType Directory -Force -Path "dist/assets" | Out-Null
          Copy-Item $exe_path -Destination "dist/"
          
          # Assets
          if (Test-Path "assets") {
              Copy-Item -Path "assets/*" -Destination "dist/assets" -Recurse
              if (-not (Test-Path "dist/assets/characters.png")) {
                  Write-Error "‚ùå Critical: missing assets!"
                  exit 1
              }
          }
          
          # Metadata
          $short_sha = "${{ github.sha }}".Substring(0, 7)
          $metadata = @{
            name = "Aether Strike"
            version = "0.1.0-$short_sha"
            executable = "${{ env.GAME_NAME }}.exe"
            description = "RPG Stick War - Turn-based combat game"
            size_mb = "$size_mb MB"
            build_date = $build_date
            commit = "${{ github.sha }}"
            platform = "windows"
            architecture = "x64"
            download_url = "https://github.com/Ryan-DPC/Vext-platform/releases/download/dev-latest/${{ env.GAME_NAME }}_v0.1.0_windows_x64.zip"
            update_url = "https://api.github.com/repos/Ryan-DPC/Vext-platform/releases/tags/dev-latest"
            requires = @{ os = "Windows 10+"; ram_mb = 512; disk_mb = 100 }
            launch_args = @("--vext-token {token}", "--vext-user-id {user_id}", "--vext-server {server_url}", "--fullscreen")
            save_data_path = "%APPDATA%/AetherStrike"
          }
          $metadata | ConvertTo-Json -Depth 10 | Out-File -FilePath "dist/game_metadata.json" -Encoding utf8
          
          # Validate Executable
          if (-not (Test-Path "dist/${{ env.GAME_NAME }}.exe")) { throw "Executable missing" }
          
          # Zip Archive
          $archive_name = "${{ env.GAME_NAME }}_v0.1.0_windows_x64.zip"
          Compress-Archive -Path "dist/*" -DestinationPath $archive_name -Force
          echo "archive_name=$archive_name" >> $env:GITHUB_ENV

      - name: üì§ Upload game artifact (for VEXT)
        uses: actions/upload-artifact@v4
        with:
          name: aether_strike_release_${{ github.sha }}
          path: ${{ env.GAME_PATH }}/dist/
          retention-days: 30
          if-no-files-found: error

      - name: üì§ Upload release archive
        uses: actions/upload-artifact@v4
        with:
          name: aether_strike_archive
          path: ${{ env.GAME_PATH }}/${{ env.archive_name }}
          retention-days: 90

      - name: üìä Build summary
        shell: powershell
        run: |
          @'
          ## üéÆ Aether Strike Build Summary
          
          | Property | Value |
          |----------|-------|
          | **Game** | Aether Strike |
          | **Version** | 0.1.0 |
          | **Platform** | Windows x64 |
          | **Size** | ${{ steps.prepare_release.outputs.exe_size }} |
          | **Build Date** | ${{ steps.prepare_release.outputs.build_date }} |
          | **Commit** | ${{ github.sha }} |
          
          ### üì• Downloads
          - Game files: `aether_strike_release_${{ github.sha }}`
          - Archive: `aether_strike_archive`
          
          ### üöÄ VEXT Integration
          Game package is ready for VEXT launcher integration.
          Metadata file included: `game_metadata.json`
          '@ | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8

  # Cr√©er une Release automatique (Nightly / Dev Build)
  create-release:
    name: Create/Update Dev Release
    needs: build-game
    runs-on: ubuntu-latest
    permissions:
      contents: write  # N√©cessaire pour cr√©er/modifier des releases
    # Plus de condition sur les tags, √ßa se lance √† chaque build r√©ussi sur dev
    
    steps:
      - name: üì• Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: aether_strike_archive
          path: ./release

      - name: üè∑Ô∏è Update Dev Release
        uses: softprops/action-gh-release@v1
        with:
          name: Aether Strike - Dev Build (${{ github.sha }})
          tag_name: dev-latest
          files: ./release/*.zip
          draft: false
          prerelease: true
          generate_release_notes: true
          body: |
            ## üöß Development Build
            **Commit:** `${{ github.sha }}`
            **Date:** ${{ github.event.head_commit.timestamp }}
            
            Cette release contient la derni√®re version de d√©velopement.
            
            ### üì• Installation
            1. T√©l√©charger le fichier `.zip` ci-dessous
            2. Extraire et lancer `aether_strike.exe`
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Job de test pour VEXT
  test-vext-integration:
    name: Test VEXT Integration
    needs: build-game
    runs-on: windows-latest
    
    steps:
      - name: üì• Download game artifact
        uses: actions/download-artifact@v4
        with:
          name: aether_strike_release_${{ github.sha }}
          path: ./game_test

      - name: üß™ Validate VEXT metadata
        shell: powershell
        working-directory: ./game_test
        run: |
          echo "Validating VEXT metadata..."
          
          # V√©rifier que game_metadata.json existe
          if (-not (Test-Path "game_metadata.json")) {
            echo "‚ùå game_metadata.json not found!"
            exit 1
          }
          
          # Lire et valider le JSON
          $metadata = Get-Content "game_metadata.json" | ConvertFrom-Json
          
          echo "‚úÖ Metadata validation:"
          echo "  - Game name: $($metadata.name)"
          echo "  - Version: $($metadata.version)"
          echo "  - Executable: $($metadata.executable)"
          echo "  - Platform: $($metadata.platform)"
          echo "  - Size: $($metadata.size_mb)"
          
          # V√©rifier que l'ex√©cutable mentionn√© existe
          if (-not (Test-Path $metadata.executable)) {
            echo "‚ùå Executable $($metadata.executable) not found!"
            exit 1
          }
          
          echo "‚úÖ All VEXT metadata validations passed!"

      - name: üìù Generate VEXT installation script
        shell: powershell
        working-directory: ./game_test
        run: |
          # Cr√©er un script d'installation pour VEXT
          @"
          # Aether Strike - VEXT Installation Script
          # Generated: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')
          
          param(
              [string]`$InstallPath = "`$env:PROGRAMFILES\Ether Platform\Games\AetherStrike"
          )
          
          Write-Host "üéÆ Installing Aether Strike..." -ForegroundColor Cyan
          
          # Cr√©er le dossier d'installation
          if (-not (Test-Path `$InstallPath)) {
              New-Item -ItemType Directory -Force -Path `$InstallPath | Out-Null
          }
          
          # Copier les fichiers
          Copy-Item -Path "*" -Destination `$InstallPath -Recurse -Force
          
          # Cr√©er le dossier de sauvegarde
          `$SavePath = "`$env:APPDATA\AetherStrike"
          if (-not (Test-Path `$SavePath)) {
              New-Item -ItemType Directory -Force -Path `$SavePath | Out-Null
          }
          
          # Cr√©er un raccourci sur le bureau
          `$WshShell = New-Object -ComObject WScript.Shell
          `$Shortcut = `$WshShell.CreateShortcut("`$env:USERPROFILE\Desktop\Aether Strike.lnk")
          `$Shortcut.TargetPath = "`$InstallPath\aether_strike.exe"
          `$Shortcut.WorkingDirectory = `$InstallPath
          `$Shortcut.Description = "Aether Strike - RPG Stick War"
          `$Shortcut.Save()
          
          Write-Host "‚úÖ Installation complete!" -ForegroundColor Green
          Write-Host "Game installed to: `$InstallPath" -ForegroundColor Gray
          Write-Host "Save data location: `$SavePath" -ForegroundColor Gray
          "@ | Out-File -FilePath "vext_install.ps1" -Encoding utf8
          
          echo "‚úÖ VEXT installation script generated!"

      - name: üì§ Upload VEXT package
        uses: actions/upload-artifact@v4
        with:
          name: aether_strike_vext_package
          path: ./game_test/
          retention-days: 30
